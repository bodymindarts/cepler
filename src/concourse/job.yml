- name: {{name}}
  serial: true
  plan:
  - in_parallel:
    - { get: repo }
{{~#if has_head }}
    - { get: {{name}}-head, trigger: true }
{{~/if}}
    - get: propagator
{{~#if passed }}
      trigger: true
      passed: [{{passed}}]
{{~/if}}
  - task: prepare-workspace
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        path: cepler
        args: ["prepare", "-e", "{{name}}", "--force-clean"]
        dir: repo
  - task: execute
    config:
      platform: linux
      image_resource:
{{> user_image_resource }}
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        dir: repo
{{> user_run }}
  - in_parallel:
    - task: record-state
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: bodymindarts/cepler
            tag: latest
        inputs:
        - name: repo
        outputs:
        - name: repo
        run:
          path: cepler
          args: ["record", "-e", "{{name}}"]
          dir: repo
    - task: tag
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: bodymindarts/cepler
            tag: latest
        outputs:
        - name: tag
        run:
          path: sh
          args: ["-x", "-c", "echo {{name}} > name"]
          dir: tag
  - put: repo
    params:
      repository: repo
      merge: true
      tag: tag/name
