- name: {{name}}
  serial: true
  plan:
  - in_parallel:
{{~#if has_head }}
    - { get: {{name}}-head, trigger: true }
{{~/if}}
    - get: propagator
{{~#if passed }}
      trigger: true
      passed: [{{passed}}]
{{~/if}}
  - task: prepare-workspace
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      outputs:
      - name: repo
      params:
        GIT_URL: {{repo_url}}
        GIT_BRANCH: {{branch}}
        GIT_PRIVATE_KEY: {{git_private_key}}
      run:
        path: cepler
        args: ["prepare", "-e", "{{name}}", "--force-clean", "--clone", "repo"]
        dir: repo
  - task: execute
    config:
      platform: linux
      image_resource:
{{> user_image_resource }}
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        dir: repo
{{> user_run }}
  - task: record-state
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        path: cepler
        args: ["record", "-e", "{{name}}"]
        dir: repo
  - in_parallel:
    - put: repo
      params:
        repository: repo
        merge: true
    - put: {{name}}
      params:
        repository: repo
        merge: true
