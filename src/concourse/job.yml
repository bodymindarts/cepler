- name: {{name}}
  serial: true
  plan:
  - { get: {{name}}, trigger: true }
  - task: execute
    config:
      platform: linux
      image_resource:
{{> user_image_resource }}
      inputs:
      - name: {{name}}
        path: repo
      outputs:
      - name: repo
      run:
        dir: repo
{{> user_run }}
  - task: record-state
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        path: cepler
        args: ["record", "-e", "{{name}}"]
        dir: repo
  - task: prepare-push
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        path: git
        args: ["reset", "--hard", "HEAD"]
        dir: repo
  - in_parallel:
    - put: repo
      params:
        repository: repo
        rebase: true
    - put: {{name}}-branch
      params:
        repository: repo
        rebase: true
